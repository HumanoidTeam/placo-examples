<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="prealpha_head">

<!-- URDF FOR THE PRE-ALPHA HEAD -->
<!-- NOTE: THIS DOESNT INCLUDE ANY COLLISION BODIES OR INERTIA PROPERTIES -->
<!-- CAMERAS ARE ADDED VIA MACRO AT THE END OF THIS FILE -->

  <xacro:macro name="prealpha_head" params="parent">


    <!-- ========================================= -->
    <!-- =============== VARIABLES =============== -->
    <!-- ========================================= -->

    <xacro:property name="PI" value="3.14159"/>

    <xacro:property name="neck_link_length" value="0.18557583888"/>
    <xacro:property name="neck_link_joint_offset_x" value="0.00562346278"/>
    <xacro:property name="neck_bearing_offset" value="0.01500045109"/>

    <xacro:property name="neck_mesh_offset_x" value="-0.1218482"/>
    <xacro:property name="neck_mesh_offset_y" value="-0.04325"/>
    <xacro:property name="neck_mesh_offset_z" value="-0.3265477"/>

    <xacro:property name="head_mesh_offset_x" value="-0.096472"/>
    <xacro:property name="head_mesh_offset_y" value="-0.0804251"/>
    <xacro:property name="head_mesh_offset_z" value="-0.1141709"/>

    <xacro:property name="d455_mount_angle_deg" value="20.0"/>

    <!-- JOINT LIMITS -->
    <xacro:property name="yaw_limit_upper_deg" value="90.0"/>
    <xacro:property name="yaw_limit_lower_deg" value="-90.0"/>

    <xacro:property name="pitch_limit_upper_deg" value="30.0"/>
    <xacro:property name="pitch_limit_lower_deg" value="-30.0"/>


    <!-- ===================================== -->
    <!-- =============== LINKS =============== -->
    <!-- ===================================== -->

    <!-- NECK LINK -->
    <link name="neck_link">
      <visual>
        <origin xyz="${neck_mesh_offset_x} ${neck_mesh_offset_y} ${neck_mesh_offset_z + neck_bearing_offset}" rpy="0 0 0"/>

        <geometry>
          <mesh filename="package://prealpha_description/meshes/prealpha_neck.stl" scale="0.001 0.001 0.001"/>
        </geometry>

        <material name="gray">
          <color rgba=".2 .2 .2 1"/>
        </material>
      </visual>

      <collision>
        <origin xyz="0 0 0.115" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.05" length="0.230" />
        </geometry>
      </collision>
    </link>

    <!-- HEAD LINK -->
    <link name="head_link">
      <visual>
        <origin xyz="${head_mesh_offset_x + 0.03} ${head_mesh_offset_y} ${head_mesh_offset_z + 0.05}" rpy="0 0 0"/>

        <geometry>
          <mesh filename="package://prealpha_description/meshes/prealpha_head.stl" scale="0.001 0.001 0.001"/>
        </geometry>

        <material name="gray_visor">
          <color rgba=".2 .2 .2 0.5"/>
        </material>
      </visual>

      <collision>
        <origin xyz="0 0 0.075" rpy="0 0 0"/>
        <geometry>
          <sphere radius="0.15" />
        </geometry>
      </collision>
    </link>


    <!-- ====================================== -->
    <!-- =============== JOINTS =============== -->
    <!-- ====================================== -->

    <!-- BASE TO NECK JOINT - YAW -->
    <joint name="head_0" type="revolute">
      <parent link="${parent}"/>
      <child link="neck_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>

      <axis xyz="0 0 1" />
      <limit upper="${(yaw_limit_upper_deg  / 180.0) * PI}" lower="${(yaw_limit_lower_deg  / 180.0) * PI}" effort="1000" velocity="0.5"/>
    </joint>

    <!-- NECK TO HEAD JOINT - PITCH -->
    <joint name="head_1" type="revolute">
      <parent link="neck_link"/>
      <child link="head_link"/>

      <origin xyz="${neck_link_joint_offset_x} 0 ${neck_link_length + neck_bearing_offset}" rpy="0 0 0"/>
      <axis xyz="0 1 0" />
      <limit upper="${(pitch_limit_upper_deg  / 180.0) * PI}" lower="${(pitch_limit_lower_deg  / 180.0) * PI}" effort="10" velocity="0.5"/>
    </joint>


    <!-- ============================================== -->
    <!-- =============== ADDING SENSORS =============== -->
    <!-- ============================================== -->

    <!-- FRONT REALSENSE -->
    <xacro:include filename="$(find realsense2_description)/urdf/_d455.urdf.xacro"/>
    <xacro:sensor_d455 name="d455_front" parent="head_link">
        <origin xyz="0.05829383278 0 -0.02829583456" rpy="0 ${(d455_mount_angle_deg / 180.0) * PI} 0"/>
    </xacro:sensor_d455>

    <!-- REAR REALSENSE -->
    <xacro:include filename="$(find realsense2_description)/urdf/_d455.urdf.xacro" />
    <xacro:sensor_d455 name="d455_rear" parent="head_link">
        <origin xyz="-0.02112981908 0 0.01841936339" rpy="0 ${(d455_mount_angle_deg / 180.0) * PI} ${PI}"/>
    </xacro:sensor_d455>

  </xacro:macro>
</robot>
